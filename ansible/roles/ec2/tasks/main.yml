- name: Create VPC and subnet 
  ec2_vpc_net:
    name: WordpressVPC
    cidr_block: "{{ cidir_vpc }}/16"
    state: present
    region: "{{ aws_region }}"
    tags:
      module: ec2_vpc_net
  register: NewVPC

- name: Create subnet 
  ec2_vpc_subnet:
    state: present
    vpc_id: "{{ NewVPC.vpc.id }}" 
    cidr: "{{ cidir_vpc }}/24"
    region: "{{ aws_region }}"
    resource_tags:
      Name: Wordpress Subnet
  register: wordpress_subnet

- name: create Gateway 
  ec2_vpc_igw:
    vpc_id: "{{ NewVPC.vpc.id }}"
    state: present
    region: "{{ aws_region }}"
  register: igw

- name: Set up public subnet route table
  ec2_vpc_route_table:
    vpc_id: "{{ NewVPC.vpc.id }}"
    region: "{{ aws_region }}"
    tags:
      Name: PublicWP
    subnets:
      - "{{ wordpress_subnet.subnet.id }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw.gateway_id }}"
  register: public_route_table

- name: Create security group for this instance 
  ec2_group:
    name: ansible_security_group
    description: ansible security group
    state: present 
    region: us-east-2
    vpc_id: "{{ NewVPC.vpc.id }}"
    rules:
        - proto: tcp
          from_port: 22
          to_port: 22
          cidr_ip: 0.0.0.0/0
        - proto: tcp
          from_port: 80
          to_port: 80
          cidr_ip: 0.0.0.0/0
        - proto: tcp
          from_port: 443
          to_port: 443
          cidr_ip: 0.0.0.0/0
    rules_egress:
        - proto: all
          cidr_ip: 0.0.0.0/0
  register: basic_firewall

- name: Create keys 
  ec2_key: 
    name: WordpressServer
    region: "{{ aws_region }}"
  register: serverKeys 

- name: save Private key 
  copy: 
    content: "{{ serverKeys.key.private_key }}"
    dest: "./WordpressServer.pem"
    mode: 0600
  when: serverKeys.changed

- name: Create Ec2 instance 
  ec2: 
    key_name: "WordpressServer"
    region: "{{ aws_region }}"
    group_id: "{{basic_firewall.group_id}}"
    instance_type: t2.micro
    image: "{{aws_image}}"
    wait: yes
    exact_count: 1
    count_tag: 
      Name: Wordpress
    instance_tags:
      Name: WordpressServer
    vpc_subnet_id: "{{ wordpress_subnet.subnet.id }}"
    assign_public_ip: yes
  register: ec2 

- name: Add all instance public IPs to host group
  add_host: hostname={{ item.public_ip }} groups=ec2hosts
  with_items: "{{ ec2.instances }}"

- name: Add all ips to hosts file 
  lineinfile: 
              dest: "inventory/hosts" 
              regexp: "{{ item.public_ip }}" 
              insertafter: "[webserver]"
              line: "{{ item.public_ip }} ansible_ssh_user=ec2-user ansible_ssh_private_key_file=WordpressServer.pem"
              state: present
  with_items: "{{ ec2.instances }}"

# wait for the host to be added 
- wait_for: path="inventory/hosts" search_regex="ansible_ssh_user=ec2-user ansible_ssh_private_key_file=WordpressServer.pem"

- name: Wait for SSH to come up
  wait_for:
    host: "{{ item.public_ip }}"
    port: 22
    state: started
  with_items: "{{ ec2.instances }}"

# refresh hosts
- meta: refresh_inventory





